---
import Layout from '~/layouts/PageLayout.astro';
import Hero from '~/components/widgets/Hero.astro';
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';

export const getStaticPaths = (async () => {
  const sermons = await getCollection('sermons');
  return sermons.map((sermon) => ({
    params: { slug: sermon.id },
    props: { sermon },
  }));
}) satisfies GetStaticPaths;

const { sermon } = Astro.props;

// For .mdoc files from Keystatic, we need to handle rendering differently
let Content;
let contentBody = '';

try {
  const rendered = await sermon.render();
  Content = rendered.Content;
} catch (error) {
  console.error('Error rendering sermon content:', error);
  contentBody = sermon.body || '';
}

const date = new Date(sermon.data.date);
const formattedDate = date.toLocaleDateString('uk-UA', {
  day: 'numeric',
  month: 'long',
  year: 'numeric'
});

const metadata = {
  title: sermon.data.title,
};
---

<Layout metadata={metadata}>
  <!-- Hero Widget ******************* -->
  <Hero>
    <Fragment slot="title">
      {sermon.data.title}
    </Fragment>

    <Fragment slot="subtitle">
      <div class="space-y-2">
        <p class="text-lg">{formattedDate}</p>
        {sermon.data.preacher && (
          <p class="text-base">Проповідник: {sermon.data.preacher}</p>
        )}
        {sermon.data.occasion && (
          <p class="text-base">Привід: {sermon.data.occasion}</p>
        )}
      </div>
    </Fragment>
  </Hero>

  <!-- Біблійне читання *************** -->
  {sermon.data.bibleReading && (
    <div class="mx-auto max-w-3xl px-4 sm:px-6 py-8">
      <div class="bg-blue-50 dark:bg-slate-800 rounded-lg p-6 md:p-8 border-l-4 border-accent">
        <h3 class="text-lg font-semibold mb-2">Біблійне читання:</h3>
        <p class="text-lg italic">{sermon.data.bibleReading}</p>
      </div>
    </div>
  )}

  <!-- Основний контент *************** -->
  <div class="mx-auto max-w-3xl px-4 sm:px-6 py-8 md:py-12">
    <div class="prose prose-lg dark:prose-invert max-w-none">
      {Content ? (
        <Content />
      ) : contentBody ? (
        <div set:html={contentBody} />
      ) : (
        <p>Контент завантажується...</p>
      )}
    </div>
  </div>

  <!-- Теги *************** -->
  {sermon.data.tags && sermon.data.tags.length > 0 && (
    <div class="mx-auto max-w-3xl px-4 sm:px-6 pb-8">
      <div class="flex flex-wrap gap-2">
        <span class="font-semibold">Теги:</span>
        {sermon.data.tags.map((tag) => (
          <span class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-sm px-3 py-1 rounded-full">
            {tag}
          </span>
        ))}
      </div>
    </div>
  )}

  <!-- Навігація *************** -->
  <div class="mx-auto max-w-3xl px-4 sm:px-6 pb-12 md:pb-16">
    <div class="flex justify-center">
      <a
        href="/sermons"
        class="btn btn-primary"
      >
        ← Повернутися до списку проповідей
      </a>
    </div>
  </div>
</Layout>
