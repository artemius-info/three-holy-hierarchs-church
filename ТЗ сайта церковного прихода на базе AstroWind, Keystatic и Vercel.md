---
title: Сайт церковного прихода на базе AstroWind, Keystatic и Vercel
created: 2025-02-03
tags:
  - Projects
---
## Техническая спецификация: Автономное развертывание и конфигурация веб-инфраструктуры на базе AstroWind, Keystatic и Vercel

## 1\. Введение и архитектурный контекст

Современная экосистема веб-разработки переживает смену парадигмы, смещаясь от монолитных серверных решений к распределенным архитектурам JAMstack (JavaScript, APIs, Markup), которые обеспечивают беспрецедентный уровень производительности, безопасности и масштабируемости. В контексте данной технической спецификации рассматривается задача проектирования и декомпозиции работ для автономного интеллектуального агента, целью которого является развертывание веб-ресурса корпоративного уровня. В качестве технологического фундамента выбрана связка фреймворка Astro (версии 5.0+), стартового шаблона AstroWind и системы управления контентом Keystatic, с последующим развертыванием в бессерверной среде Vercel.

Выбор данного технологического стека обусловлен необходимостью достижения максимальных показателей в метриках Core Web Vitals при сохранении гибкости управления данными. AstroWind, использующий архитектуру Astro Islands, позволяет минимизировать объем клиентского JavaScript, отправляя в браузер преимущественно статический HTML, что критически важно для SEO и пользовательского опыта на мобильных устройствах. Внедрение Keystatic решает проблему управления контентом, предоставляя графический интерфейс для редактирования файлов Markdown, MDX и Markdoc непосредственно в Git-репозитории, устраняя необходимость во внешней базе данных и снижая инфраструктурную сложность.

Настоящий документ представляет собой исчерпывающее техническое задание (ТЗ), предназначенное для исполнения ИИ-агентом. Документ не просто перечисляет шаги, но и предоставляет глубокий анализ архитектурных решений, стратегий обработки данных (включая сложные типы, такие как повторяющиеся события) и методов синхронизации схем валидации. Особое внимание уделяется "подводным камням" интеграции, таким как дублирование схем данных между Zod (Astro Content Collections) и Keystatic Config, а также настройке аутентификации в среде Vercel.

## 2\. Анализ базовой инфраструктуры и стратегия инициализации

### 2.1. Анатомия шаблона AstroWind

Шаблон AstroWind представляет собой сложную, предварительно сконфигурированную систему, базирующуюся на Tailwind CSS. В отличие от "чистых" установок Astro, AstroWind навязывает определенную структуру директорий и паттерны разработки, которые агент должен строго соблюдать для предотвращения конфликтов сборки. Ключевой особенностью шаблона является глубокая интеграция дизайн-системы через конфигурационные файлы и CSS-переменные, что требует специфического подхода к кастомизации.

Файловая структура проекта имеет критическое значение для понимания области действия агента:

### 2.2. Стратегия очистки демонстрационного контента (Sanitization Strategy)

Одной из наиболее рискованных операций при работе с готовыми шаблонами является удаление демонстрационного контента. AstroWind содержит множество взаимосвязанных файлов: статьи блога ссылаются на авторов, страницы портфолио используют специфические виджеты, а файл навигации ссылается на маршруты, которые подлежат удалению. Простое удаление `.md` файлов приведет к фатальным ошибкам сборки из-за нарушения целостности графа зависимостей и импортов.

Анализ показывает, что корректная стратегия очистки должна включать не только физическое удаление файлов, но и рефакторинг кода. Например, коллекция `blog` в Astro Content Collections требует наличия хотя бы одного файла для корректного вывода типов TypeScript. Если удалить все файлы, `getCollection('post')` может вернуть ошибку типизации или пустого массива, который не обрабатывается компонентами UI. Следовательно, агент должен реализовать механизм замены демо-контента на "заглушки" (placeholders) перед наполнением реальными данными.

### 2.3. Управление зависимостями и окружением

Для обеспечения стабильности проекта необходимо зафиксировать версии ключевых библиотек. Согласно исследовательским данным, AstroWind активно обновляется, поддерживая  Astro 5.17 и Tailwind CSS 4.1. Агент должен использовать менеджер пакетов `npm` или `pnpm` с обязательной генерацией лок-файла (`package-lock.json` или `pnpm-lock.yaml`) для гарантии воспроизводимости среды.


```cardlink
url: https://docs.astro.build/en/getting-started/
title: "Getting started"
description: "Guides, resources, and API references to help you build with Astro — the web framework for content-driven websites."
host: docs.astro.build
favicon: https://docs.astro.build/favicon.ico
image: https://docs.astro.build/open-graph/en/getting-started.webp
```

```cardlink
url: https://tailwindcss.com/docs/installation/using-vite
title: "Installing with Vite - Installation"
description: "Integrate Tailwind CSS with frameworks like Laravel, SvelteKit, React Router, and SolidJS."
host: tailwindcss.com
favicon: https://tailwindcss.com/favicons/favicon-32x32.png?v=4
image: https://tailwindcss.com/api/og?path=/docs/installation/using-vite
```

## 3\. Интеграция системы управления контентом (Keystatic)

### 3.1. Архитектурная модель Keystatic в экосистеме Astro

Keystatic фундаментально отличается от Headless CMS (Contentful, Sanity) тем, что работает в парадигме "Local-First". В режиме разработки контент сохраняется непосредственно в файловую систему (`src/content/...`), что позволяет использовать горячую перезагрузку (HMR) Astro для мгновенного отображения изменений. В продакшене (на Vercel) Keystatic переключается в "GitHub Mode", где изменения коммитятся в репозиторий через GitHub API.

Эта двойственность требует от агента настройки гибридной конфигурации в `keystatic.config.ts`. Необходимо реализовать условную логику, которая определяет режим работы (`local` или `github`) на основе переменных окружения.

**Сравнительный анализ режимов хранения:**

| Режим (Kind) | Среда применения | Механизм записи | Требования к Auth |
| --- | --- | --- | --- |
| **Local** | Локальная разработка (`npm run dev`) | Прямая запись в FS | Не требуется |
| **GitHub** | Продакшен / Vercel Deploy | GitHub API (Commits) | GitHub OAuth App |
| **Cloud** | Альтернатива GitHub Mode | Keystatic Cloud API | Keystatic Cloud аккаунт |

*Примечание:* В рамках данного ТЗ приоритет отдается режиму **GitHub**, так как он обеспечивает полный контроль над данными без зависимости от сторонних SaaS решений для хранения.

### 3.2. Проблема двойной схемы (The Dual Schema Problem)

Критическим архитектурным вызовом при использовании Astro Content Collections совместно с Keystatic является необходимость дублирования описания структуры данных. Astro использует библиотеку **Zod** для валидации контента во время сборки (`src/content/config.ts`), гарантируя, что все обязательные поля присутствуют и имеют правильный тип. Keystatic использует собственные методы (`fields.text`, `fields.slug`) для построения интерфейса администратора в `keystatic.config.ts`.

Рассинхронизация этих двух схем является частой причиной сбоев. Например, если добавить поле `author` как обязательное в Zod-схеме Astro, но не добавить его в конфиг Keystatic, редактор не сможет заполнить это поле, и сборка сайта упадет. Агент должен получить инструкции по синхронному обновлению обоих конфигурационных файлов при любых изменениях модели данных.

### 3.3. Маршрутизация и безопасность Админ-панели

Keystatic встраивается в Astro как интеграция, монтирующая панель управления по маршруту `/keystatic`. Поскольку AstroWind по умолчанию настроен на статическую генерацию (`output: 'static'`), админ-панель будет представлять собой SPA (Single Page Application). Для корректной работы API-роутов, необходимых для GitHub-аутентификации, необходимо перевести проект в режим `output: 'hybrid'` или использовать адаптер Vercel с поддержкой Serverless Functions. Исследования показывают, что использование `@astrojs/vercel` адаптера является оптимальным решением, позволяя сочетать статику для фронтенда и серверные функции для API админки.

## 4\. Глубокое моделирование данных и сущностей

Особую сложность в проекте представляет реализация нетривиальных типов контента, выявленных в ходе исследования: "Проповеди" (Sermons) и "Повторяющиеся события" (Recurring Events). Стандартные возможности CMS часто не покрывают такие сценарии, требуя кастомной инженерной реализации.

### 4.1. Сущность "Проповеди" (Sermons): Мультимедийный контент

Сущность "Проповедь" требует работы с аудиофайлами. В контексте Git-based CMS хранение больших бинарных файлов (MP3) непосредственно в репозитории является плохой практикой, так как это раздувает размер `.git` директории. Однако, для простоты начальной реализации и при небольшом объеме файлов, допустимо сохранение их в `public/audio`.

**Спецификация полей:**

- **Audio Source:** Поле типа `file` в Keystatic с указанием `directory: 'public/audio'` и `publicPath: '/audio/'`. Это обеспечит прямую ссылку на файл.
- **Third-party Hosting (Альтернатива):** Поле типа `url` для ссылок на внешние CDN (AWS S3, Cloudinary), что предпочтительнее для масштабируемости.
- **Метаданные:** Серия проповедей, Проповедник, Дата, Ссылка на Писание.

### 4.2. Сущность "Повторяющиеся события" (Recurring Events): Реализация паттерна RRULE

Проблема повторяющихся событий в статических сайтах стоит особенно остро. В отличие от традиционных баз данных, где можно выполнить SQL-запрос для генерации списка событий на лету, в Astro необходимо сгенерировать все страницы событий во время сборки (Build Time).

Исследования баз данных предлагают два подхода: создание "родительского" события с таблицей исключений или хранение правил повторения. Для Keystatic оптимальным является **хранение правила повторения (RRULE)** в виде метаданных одного "Мастер-события".

**Алгоритм реализации для Агента:**

1. **Схема данных:** Вместо даты события хранится дата начала повторений, тип повтора (Еженедельно, Ежемесячно) и дни недели.
2. **Генерация (Build Time Expansion):** Агент должен реализовать утилиту на TypeScript, которая при сборке сайта считывает все "Мастер-события", использует библиотеку `rrule` (Recurrence Rules) для вычисления конкретных дат на заданный горизонт планирования (например, на 12 месяцев вперед) и формирует массив виртуальных событий.
3. **Отображение:** Виртуальные события сортируются по времени и передаются в компонент календаря или списка.

Такой подход позволяет редактору создать одну запись "Воскресное служение", а на сайте получить расписание на год вперед без необходимости вручную создавать 52 записи.

## 5\. Декомпозиция задач для ИИ-агента

Ниже представлена детальная декомпозиция работ на технические задачи (Tasks), сгруппированные по Эпикам. Каждая задача содержит контекст, инструкции и критерии приемки.

### Эпик 1: Инициализация и Санитизация Проекта

#### Task 1.1: Развертывание базовой архитектуры

**Контекст:** Необходимо развернуть шаблон AstroWind, гарантируя совместимость версий.**Инструкции:**

1. Инициализировать проект командой `npm create astro@latest -- --template onwidget/astrowind` (использовать флаг `--yes` для автоматического подтверждения).
2. Выбрать опцию установки зависимостей (Install dependencies).
3. Выбрать опцию инициализации Git репозитория.
4. Проверить файл `package.json`: убедиться, что версия `astro` >= 5.0. Если нет, выполнить `npm install astro@latest`.**Критерий приемки:** При запуске `npm run dev` сервер стартует на порту 4321, главная страница AstroWind открывается в браузере.

#### Task 1.2: Глубокая очистка демонстрационного контента

**Контекст:** Удаление демо-файлов без нарушения целостности ссылок.**Инструкции:**

1. Удалить все файлы из `src/content/post/`, кроме файла-заглушки (создать `src/content/post/placeholder.md` с валидным frontmatter: `title: Placeholder`, `publishDate: 2024-01-01`).
2. Удалить директорию `src/pages/landing` и файлы `src/pages/services.astro`, `src/pages/pricing.astro`.
3. Модифицировать `src/navigation.js`: удалить элементы массивов `headerData` и `footerData`, ссылающиеся на удаленные страницы, оставив только ссылки на `Home` и `Blog`.
4. Очистить `src/assets/images`, оставив только `default.png` и `favicon`.**Критерий приемки:** Команда `npm run build` выполняется без ошибок `Broken Link` или `Image missing`.

### Эпик 2: Интеграция CMS Keystatic

#### Task 2.1: Установка ядра и адаптеров

**Контекст:** Подключение библиотек CMS к проекту Astro.**Инструкции:**

1. Выполнить установку пакетов: `npm install @keystatic/core @keystatic/astro`.
2. Установить React и Markdoc интеграции: `npx astro add react markdoc`. Согласиться на изменение конфига.**Критерий приемки:** В `package.json` присутствуют `@keystatic/core` и `@keystatic/astro`.

#### Task 2.2: Конфигурация Astro Integration

**Контекст:** Настройка порядка загрузки интеграций в `astro.config.mjs`.**Инструкции:**

1. Импортировать `keystatic` из `@keystatic/astro` в `astro.config.mjs`.
2. Добавить вызов `keystatic()` в массив `integrations`.
3. Убедиться, что `keystatic()` находится в массиве, и при необходимости изменить `output` на `'hybrid'` или `'server'` (для поддержки API маршрутов в будущем), хотя для начала оставить `'static'` с адаптером Vercel (см. Эпик 5).**Критерий приемки:** Файл `astro.config.mjs` валиден, сервер запускается.

#### Task 2.3: Реализация конфигурации схем (keystatic.config.ts)

**Контекст:** Создание точки входа для управления контентом.**Инструкции:**

1. Создать файл `keystatic.config.ts` в корне проекта.
2. Реализовать экспорт конфигурации с использованием условного оператора для `storage`:
	
	```TypeScript
	import { config, fields, collection } from '@keystatic/core';
	export default config({
	  storage: process.env.NODE_ENV === 'production'
	   ? { kind: 'github', repo: 'USER/REPO' } // Будет заменено на реальные данные
	    : { kind: 'local' },
	  collections: {
	    // Коллекции будут добавлены в Эпике 3
	    posts: collection({
	       label: 'Posts',
	       slugField: 'title',
	       path: 'src/content/post/*',
	       format: { contentField: 'content' },
	       schema: {
	         title: fields.slug({ name: { label: 'Title' } }),
	         content: fields.markdoc({ label: 'Content' }),
	       }
	    })
	  },
	});
	```

**Критерий приемки:** По адресу `/keystatic` доступен интерфейс администратора.

### Эпик 3: Моделирование данных (Data Engineering)

#### Task 3.1: Синхронизация схем Блога

**Контекст:** AstroWind требует специфические поля для постов.**Инструкции:**

1. Прочитать `src/content/config.ts` и выписать все поля Zod-схемы для коллекции `post` (обычно это `publishDate`, `image`, `tags`, `category`, `draft`, `metadata`).
2. Добавить аналогичные поля в `keystatic.config.ts` в коллекцию `posts`.
	- Для `image` использовать `fields.image({ directory: 'src/assets/images/blog', publicPath: '@assets/images/blog/' })`.
	- Для `publishDate` использовать `fields.date()`.**Критерий приемки:** Создание поста через Keystatic создает `.md` файл, который проходит валидацию Zod в Astro.

#### Task 3.2: Реализация коллекции "Sermons"

**Контекст:** Создание новой сущности для аудио-контента.**Инструкции:**

1. В `keystatic.config.ts` добавить коллекцию `sermons`. Поля: `title`, `preacher`, `date`, `audioFile` (тип `file`), `description`.
2. В `src/content/config.ts` создать новую коллекцию `sermons` с помощью `defineCollection` и соответствующей Zod-схемы.
3. Экспортировать новую коллекцию в объекте `collections`.**Критерий приемки:** Наличие папки `src/content/sermons` и возможность добавлять записи через UI.

#### Task 3.3: Реализация логики повторяющихся событий (Recurring Events)

**Контекст:** Реализация сложной временной логики.**Инструкции:**

1. В `keystatic.config.ts` создать коллекцию `events`.
2. Добавить поля для паттерна повторения:
	- `isRecurring`: `fields.checkbox({ label: 'Recurring Event?' })`.
	- `frequency`: `fields.select({ options: })`.
	- `byDay`: `fields.multiselect` (дни недели).
	- `startDate`: `fields.datetime`.
	- `count`: `fields.integer` (количество повторений, опционально).
3. В `src/content/config.ts` добавить валидацию для этих полей.**Критерий приемки:** Модель данных позволяет описать событие "Каждое воскресенье в 10:00".

### Эпик 4: Дизайн-система и Кастомизация

#### Task 4.1: Темизация через CSS-переменные

**Контекст:** AstroWind использует слой абстракции над Tailwind.**Инструкции:**

1. Открыть `src/components/CustomStyles.astro`.
2. Изменить значения `--aw-color-primary`, `--aw-color-secondary`, `--aw-color-accent`. Значения должны быть указаны в формате RGB-триплетов (например, `126 34 206`), а не HEX, для поддержки прозрачности в утилитах Tailwind (`bg-primary/50`).
3. Проверить, что `tailwind.config.js` ссылается на эти переменные.

#### Task 4.2: Интеграция шрифтов

**Контекст:** Подключение кастомной типографики.**Инструкции:**

1. Выбрать шрифты (например, Inter и Merriweather).
2. Добавить `@font-face` или импорт Google Fonts в `src/assets/styles/tailwind.css` или `CustomStyles.astro`.
3. Обновить переменные `--aw-font-sans` и `--aw-font-serif`.

### Эпик 5: Деплоймент на Vercel

#### Task 5.1: Настройка адаптера Vercel

**Контекст:** Обеспечение работы SSR и API роутов.**Инструкции:**

1. Выполнить `npx astro add vercel`.
2. В `astro.config.mjs` убедиться в наличии `adapter: vercel()`.
3. Установить `output: 'hybrid'` для оптимизации (статика для контента, сервер для админки).

#### Task 5.2: Генерация инструкции по безопасности и OAuth

**Контекст:** Агент не может настроить GitHub OAuth App самостоятельно.**Инструкции:**

1. Сгенерировать файл `DEPLOY_INSTRUCTIONS.md` с пошаговым руководством для пользователя:
	- Как создать GitHub OAuth App.
	- Какой `Homepage URL` указать (URL Vercel проекта).
	- Какой `Authorization callback URL` указать (`/keystatic/api/github/oauth/callback`).
	- Какие переменные окружения добавить в Vercel: `KEYSTATIC_GITHUB_CLIENT_ID`, `KEYSTATIC_GITHUB_CLIENT_SECRET`, `KEYSTATIC_SECRET` (для сессий), `NEXT_PUBLIC_KEYSTATIC_GITHUB_APP_SLUG`.

#### Task 5.3: CI/CD Pipeline

**Контекст:** Автоматизация сборки.**Инструкции:**

1. Убедиться, что в `package.json` есть скрипт `build`.
2. При деплое на Vercel выбрать пресет `Astro`.

## 6\. Стратегия качества и тестирования

Для обеспечения надежности разрабатываемого решения агент должен внедрить следующие проверки:

1. **Type Check:** В `package.json` добавить скрипт `"check": "astro check && tsc --noEmit"`. Это гарантирует, что типы контента соответствуют коду компонентов.
2. **Linting:** Использовать `eslint` с плагином `astro-eslint-parser` для проверки стиля кода.
3. **Build Verification:** Перед финальным коммитом выполнять локальную сборку `npm run build`, чтобы убедиться, что генерация статических страниц (особенно с учетом логики повторяющихся событий) проходит корректно и не превышает лимиты памяти.

## 7\. Заключение

Представленная техническая спецификация описывает полный жизненный цикл создания веб-ресурса: от инициализации шаблона AstroWind до развертывания CMS Keystatic на платформе Vercel. Реализация паттерна повторяющихся событий через генерацию на этапе сборки и строгая синхронизация схем Zod и Keystatic обеспечивают устойчивость архитектуры. Данный план действий оптимизирован для исполнения автономным ИИ-агентом, минимизируя необходимость вмешательства человека в технические процессы, за исключением этапов, требующих доступа к секретным ключам и настройкам безопасности сторонних сервисов.

Аккаунт Google

Артур Водич

a.vodich@gmail.com